pipeline {
    agent any
    
    parameters {
        string(
            name: 'repository',
            description: 'Repo names separated by comma (e.g., repo1,repo2)',
            defaultValue: ''
        )
        string(
            name: 'github_username',
            description: 'Your GitHub username',
            defaultValue: 'Layasri-B'
        )
        string(
            name: 'branches_to_delete',
            description: 'Branch names to delete, separated by comma (e.g., feature/old,test-branch)',
            defaultValue: ''
        )
    }
    
    options {
        disableConcurrentBuilds()
        timeout(time: 30, unit: 'MINUTES')
    }
    
    stages {
        stage('Validate Parameters') {
            steps {
                script {
                    if (!params.repository?.trim()) {
                        error "repository parameter is required"
                    }
                    if (!params.github_username?.trim()) {
                        error "github_username parameter is required"
                    }
                    if (!params.branches_to_delete?.trim()) {
                        error "branches_to_delete parameter is required"
                    }
                }
            }
        }
        
        stage('Backup Repository Locally') {
            steps {
                withCredentials([
                    string(credentialsId: 'github-pat', variable: 'GITHUB_TOKEN')
                ]) {
                    sh """#!/bin/bash
                        set -e
                        
                        mkdir -p \${WORKSPACE}/github_repo/
                        cd \${WORKSPACE}/github_repo/
                        
                        backup_date=\$(date +%Y%m%d_%H%M%S)
                        
                        for repo in \$(echo "${params.repository}" | tr ',' ' ')
                        do
                            repo=\$(echo \$repo | xargs)
                            [ -z "\$repo" ] && continue
                            
                            echo ""
                            echo "=========================================="
                            echo "[INFO] Backing up: \$repo"
                            echo "=========================================="
                            
                            git clone --mirror "https://${params.github_username}:\${GITHUB_TOKEN}@github.com/${params.github_username}/\${repo}.git"
                            
                            tar -czf "\${repo}_\${backup_date}.tar.gz" "\${repo}.git"
                            
                            echo "[SUCCESS] Local backup created: \${repo}_\${backup_date}.tar.gz"
                            
                            # List the backup file
                            ls -lh "\${repo}_\${backup_date}.tar.gz"
                        done
                        
                        echo ""
                        echo "[SUCCESS] All backups completed locally!"
                    """
                }
            }
        }
        
        stage('Delete Specified Branches') {
            steps {
                withCredentials([
                    string(credentialsId: 'github-pat', variable: 'GITHUB_TOKEN')
                ]) {
                    sh """#!/bin/bash
                        set +e
                        
                        echo ""
                        echo "=========================================="
                        echo "[INFO] Starting branch deletion..."
                        echo "=========================================="
                        
                        for repo in \$(echo "${params.repository}" | tr ',' ' ')
                        do
                            repo=\$(echo \$repo | xargs)
                            [ -z "\$repo" ] && continue
                            
                            echo ""
                            echo "[INFO] Processing repo: \$repo"
                            echo "----------------------------------------"
                            
                            for branch in \$(echo "${params.branches_to_delete}" | tr ',' ' ')
                            do
                                branch=\$(echo \$branch | xargs)
                                [ -z "\$branch" ] && continue
                                
                                echo "[INFO] Deleting branch: \$branch"
                                
                                response=\$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \\
                                    -H "Authorization: token \${GITHUB_TOKEN}" \\
                                    -H "Accept: application/vnd.github.v3+json" \\
                                    "https://api.github.com/repos/${params.github_username}/\${repo}/git/refs/heads/\${branch}")
                                
                                if [ "\$response" == "204" ]; then
                                    echo "[SUCCESS] Deleted branch: \$branch from \$repo"
                                elif [ "\$response" == "422" ] || [ "\$response" == "404" ]; then
                                    echo "[WARNING] Branch \$branch not found in \$repo"
                                else
                                    echo "[ERROR] Failed to delete branch \$branch (HTTP: \$response)"
                                fi
                            done
                        done
                        
                        echo ""
                        echo "=========================================="
                        echo "[INFO] Branch deletion completed!"
                        echo "=========================================="
                    """
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
            echo 'Process completed'
        }
        success {
            echo 'Successfully backed up and deleted branches!'
        }
        failure {
            echo 'Process failed.'
        }
    }
}
