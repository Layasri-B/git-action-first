pipeline {
    agent any
    
    parameters {
        string(
            name: 'repository',
            description: 'Repo names separated by comma (e.g., repo1,repo2)',
            defaultValue: ''
        )
        string(
            name: 'github_username',
            description: 'Your GitHub username',
            defaultValue: 'Layasri-B'
        )
        string(
            name: 's3_bucket',
            description: 'S3 bucket name',
            defaultValue: 'aws-repo-backup-v1'
        )
        string(
            name: 's3_folder',
            description: 'Folder path in S3 bucket',
            defaultValue: 'repo-backups'
        )
        string(
            name: 'aws_region',
            description: 'AWS Region',
            defaultValue: 'ap-south-1'
        )
    }
    
    options {
        disableConcurrentBuilds()
        timeout(time: 2, unit: 'HOURS')
    }
    
    stages {
        stage('Validate Parameters') {
            steps {
                script {
                    if (!params.repository?.trim()) {
                        error "repository parameter is required"
                    }
                    if (!params.github_username?.trim()) {
                        error "github_username parameter is required"
                    }
                    if (!params.s3_bucket?.trim()) {
                        error "s3_bucket parameter is required"
                    }
                }
            }
        }
        
        stage('Install AWS CLI') {
            steps {
                sh """#!/bin/bash
                    if ! command -v aws &> /dev/null; then
                        echo "AWS CLI not found. Installing..."
                        curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg"
                        sudo installer -pkg AWSCLIV2.pkg -target /
                        rm AWSCLIV2.pkg
                    else
                        echo "AWS CLI already installed"
                        aws --version
                    fi
                """
            }
        }
        
        stage('Backup Repositories to S3') {
            steps {
                withCredentials([
                    string(credentialsId: 'github-pat', variable: 'GITHUB_TOKEN'),
                    usernamePassword(
                        credentialsId: 'aws-credentials',
                        usernameVariable: 'AWS_ACCESS_KEY_ID',
                        passwordVariable: 'AWS_SECRET_ACCESS_KEY'
                    )
                ]) {
                    sh """#!/bin/bash
                        set -e
                        
                        export AWS_ACCESS_KEY_ID="\${AWS_ACCESS_KEY_ID}"
                        export AWS_SECRET_ACCESS_KEY="\${AWS_SECRET_ACCESS_KEY}"
                        export AWS_DEFAULT_REGION="${params.aws_region}"
                        
                        s3_path="s3://${params.s3_bucket}/${params.s3_folder}"
                        
                        mkdir -p \${WORKSPACE}/github_repo/
                        cd \${WORKSPACE}/github_repo/
                        
                        backup_date=\$(date +%Y%m%d_%H%M%S)
                        
                        for repo in \$(echo "${params.repository}" | tr ',' ' ')
                        do
                            repo=\$(echo \$repo | xargs)
                            [ -z "\$repo" ] && continue
                            
                            echo ""
                            echo "=========================================="
                            echo "[INFO] Backing up: \$repo"
                            echo "=========================================="
                            
                            git clone --mirror "https://${params.github_username}:\${GITHUB_TOKEN}@github.com/${params.github_username}/\${repo}.git"
                            
                            tar -czf "\${repo}_\${backup_date}.tar.gz" "\${repo}.git"
                            
                            /usr/local/bin/aws s3 cp "\${repo}_\${backup_date}.tar.gz" "\${s3_path}/" || aws s3 cp "\${repo}_\${backup_date}.tar.gz" "\${s3_path}/"
                            
                            echo "[SUCCESS] Backup: \${s3_path}/\${repo}_\${backup_date}.tar.gz"
                            
                            rm -rf "\${repo}.git" "\${repo}_\${backup_date}.tar.gz"
                        done
                        
                        echo ""
                        echo "[SUCCESS] All backups completed!"
                    """
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
            echo 'Backup process completed'
        }
        success {
            echo 'Successfully backed up repositories to S3!'
        }
        failure {
            echo 'Failed to backup repositories.'
        }
    }
}
